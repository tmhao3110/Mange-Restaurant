create database Project_1_test1
go
use Project_1_test1
go

drop database Project_1_test1

CREATE TABLE NHANVIEN(
	MANV VARCHAR(10) NOT NULL PRIMARY KEY, -- MÃ NHÂN VIÊN
	MATKHAU VARCHAR(50) NOT NULL, -- MẬT KHẨU ĐỪNG BỎ NẾU BỎ THÌ LÀM FORM LOGIN UỔNG
	TENNV NVARCHAR(50) NOT NULL, -- TÊN NHÂN VIÊN
	NGAYSINH DATE NOT NULL, -- NGÀY SINH
	GIOITINH BIT NOT NULL, -- GIỚI TÍNH
	SDT VARCHAR(20) NOT NULL, -- SỐ ĐIỆN THOẠI
	EMAIL VARCHAR(50) NOT NULL,
	LOAI BIT NOT NULL DEFAULT 0, -- LOẠI PARTTIME OR FULLTIME
	HINH VARCHAR(200), -- HÌNH
	QRCODE VARCHAR(200) NOT NULL, -- QUICK RESPONSE CODE
	CHUCVU BIT NOT NULL DEFAULT 0, -- ADMIN
	DIACHI NVARCHAR(255) NOT NULL, -- ĐỊA CHỈ
);

CREATE TABLE LOAITHEKHACHHANG(
	MALOAIKHACHHANG INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
	TENLOAI NVARCHAR(50) NOT NULL
)

DBCC CHECKIDENT(LOAITHEKHACHHANG, RESEED, 0)

CREATE TABLE THEKHACHHANG(
	MAKH INT IDENTITY(1,1) NOT NULL PRIMARY KEY , -- MÃ KHÁCH HÀNG --  HAY MÃ THẺ TÙY NHA TẠI TAO THÍCH MÃ KHÁCH HÀNG ĐỂ CHỮ MÃ THẺ NÓ TỤC
	TENKH NVARCHAR(50) NOT NULL, -- TÊN KHÁCH HÀNG
	SDT VARCHAR(20), -- SỐ ĐIỆN THOẠI
	EMAIL VARCHAR(255), -- EMAIL
	TICHDIEM INT DEFAULT 0,
	MALOAIKHACHHANG INT NOT NULL,
	CONSTRAINT FK_LOAITHEKHACHHANG FOREIGN KEY (MALOAIKHACHHANG) REFERENCES LOAITHEKHACHHANG(MALOAIKHACHHANG)
);

SELECT * FROM THEKHACHHANG

CREATE TABLE LOAISANPHAM(
	MALOAISANPHAM nchar(5) NOT NULL PRIMARY KEY,
	TENLOAI NVARCHAR(50) NOT NULL,
	UNIQUE(TENLOAI),
)

CREATE TABLE SANPHAM(
	MASP int IDENTITY(1,1) NOT NULL, -- MÃ SẢN PHẨM
	MALOAISANPHAM nchar(5) NOT NULL,
	TENSP NVARCHAR(50) NOT NULL, -- TÊN SẢN PHẨM
	SOLUONG INT NOT NULL DEFAULT 0, -- SỐ LƯỢNG
	DONGIA INT NOT NULL DEFAULT 0, -- ĐƠN GIÁ
	HINH VARCHAR(200) NOT NULL, -- HÌNH SẢN PHẨM
	GHICHU NVARCHAR(255), -- GHI CHÚ
	PRIMARY KEY (MASP),
	CHECK (SOLUONG > 0 AND DONGIA >= 0), -- KIỂM TRA SỐ LƯỢNG ĐƠN GIÁ > 0
	CONSTRAINT FK_LOAISANPHAM FOREIGN KEY (MALOAISANPHAM) REFERENCES LOAISANPHAM(MALOAISANPHAM) ON UPDATE CASCADE
);

CREATE TABLE DONHANG(
	MADH VARCHAR(100) NOT NULL PRIMARY KEY, -- MÃ ĐƠN HÀNG
	MAKH INT,
	TENKH NVARCHAR(50),-- Cho thành viên 
	NGAYBAN DATE NOT NULL, -- NGÀY GIAO DỊCH ĐƠN HÀNG
	TONGTIEN INT NOT NULL,
	MANV VARCHAR(10) NOT NULL, -- KHÓA NGOẠI -- AI THANH TOÁN ĐƠN HÀNG NÀY
	CONSTRAINT FK_NHANVIEN_BANHANG FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV),
);


CREATE TABLE CHITIETDONHANG(
	MACTDH INT IDENTITY(1,1), -- KHÓA CHÍNH -- MÃ ĐƠN HÀNG
	MADH VARCHAR(100) NOT NULL,
	MASP int NOT NULL,
	TENSP NVARCHAR(50) NOT NULL, -- TÊN SẢN PHẨM
	SOLUONG INT NOT NULL, -- SỐ LƯỢNG
	DONGIA INT NOT NULL, -- ĐƠN GIÁ
	GIAMGIA float NOT NULL, -- GIẢM GIÁ
	THANHTIEN INT NOT NULL, -- ĐƠN GIÁ
	MOTA NVARCHAR(255), -- MÔ TẢss
	CONSTRAINT PK_CHITIETDONHANG PRIMARY KEY (MACTDH),
	CONSTRAINT FK_DONHANG_CTDH FOREIGN KEY (MADH) REFERENCES DONHANG(MADH),
	CONSTRAINT FK_SANPHAM_CTDH FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)
);
	delete from DONHANG
	delete from CHITIETDONHANG

	drop table DONHANG
	drop table CHITIETDONHANG
--PROC ngày
CREATE PROC SP_THONGKEDOANHTHUNGAY
AS BEGIN
	SELECT NGAYBAN, SUM(TONGTIEN) as TONGTIEN
	FROM DONHANG
	GROUP BY NGAYBAN
END

EXECUTE SP_THONGKEDOANHTHUNGAY

--Thống kê tháng
CREATE PROC SP_THONGKEDOANHTHUTHANG(@YEAR INT)
AS BEGIN
	SELECT MONTH(NGAYBAN) THANG, SUM(TONGTIEN) TONGTIEN
	FROM DONHANG
	WHERE YEAR(NGAYBAN) = @YEAR
	GROUP BY MONTH(NGAYBAN) 
END

EXECUTE SP_THONGKEDOANHTHUTHANG 2021
--thống kê năm
CREATE PROC SP_THONGKEDOANHTHUNAM
AS BEGIN
	SELECT YEAR(NGAYBAN) THANG, SUM(TONGTIEN) TONGTIEN
	FROM DONHANG
	GROUP BY YEAR(NGAYBAN)
END

EXECUTE SP_THONGKEDOANHTHUNAM 

select * from THEKHACHHANG

insert into DONHANG VALUES('HD20070101', '32', N'Võ Thị Cẩm Nguyệt', '2020-07-01', 3290000, 'nv001')
insert into DONHANG VALUES('HD20060101', '32', N'Trần Minh Hào', '2020-06-01', 3150000, 'nv001')
insert into DONHANG VALUES('HD20050101', '32', N'Đoàn Trương Gia Bảo', '2020-05-01', 1800000, 'nv001')

insert into DONHANG VALUES('HD20040101', '15', N'Đoàn Thị Mỹ Hẹn', '2020-04-01', 3330000, 'nv001')
insert into DONHANG VALUES('HD20030101', '16', N'Đoàn Thị Mỹ Kiều', '2020-03-01', 5550000, 'nv001')
insert into DONHANG VALUES('HD20020101', '17', N'Võ Đăng Quang', '2020-02-01', 4530000, 'nv001')
insert into DONHANG VALUES('HD20010101', '18', N'Bùi Minh Thông', '2020-01-01', 6660000, 'nv001')

insert into DONHANG VALUES('HD19010101', '32', N'Võ Thị Cẩm Nguyệt', '2019-01-01', 8970000, 'nv001')

insert into DONHANG VALUES('HD19020101', '32', N'Trần Minh Hào', '2019-02-01', 4860000, 'nv001')
insert into DONHANG VALUES('HD19030101', '32', N'Đoàn Trương Gia Bảo', '2019-03-01', 8880000, 'nv001')
insert into DONHANG VALUES('HD19040101', '15', N'Đoàn Thị Mỹ Hẹn', '2019-04-01', 8530000, 'nv001')
insert into DONHANG VALUES('HD19050101', '16', N'Đoàn Thị Mỹ Kiều', '2019-05-01', 6580000, 'nv001')
insert into DONHANG VALUES('HD19060101', '17', N'Võ Đăng Quang', '2019-06-01', 7850000, 'nv001')
insert into DONHANG VALUES('HD19070101', '17', N'Võ Đăng Quang', '2019-07-01', 8450000, 'nv001')
insert into DONHANG VALUES('HD19080101', '18', N'Bùi Minh Thông', '2019-08-01', 6790000, 'nv001')
insert into DONHANG VALUES('HD19090101', '18', N'Bùi Minh Thông', '2019-09-01', 8290000, 'nv001')
insert into DONHANG VALUES('HD19100101', '19', N'Đoàn Hoàng Sang', '2019-10-01', 7890000, 'nv001')
insert into DONHANG VALUES('HD19110101', '20', N'Lữ Bố', '2019-11-01', 8780000, 'nv001')
insert into DONHANG VALUES('HD19120101', '21', N'Chung Vô Diệm', '2019-12-01', 8750000, 'nv001')

insert into DONHANG VALUES('HD18010101', '32', N'Võ Thị Cẩm Nguyệt', '2018-01-01', 8880000, 'nv001')
insert into DONHANG VALUES('HD18020101', '32', N'Trần Minh Hào', '2018-02-01', 5550000, 'nv001')
insert into DONHANG VALUES('HD18030101', '32', N'Đoàn Trương Gia Bảo', '2018-03-01', 7770000, 'nv001')
insert into DONHANG VALUES('HD18040101', '15', N'Đoàn Thị Mỹ Hẹn', '2018-04-01', 9990000, 'nv001')
insert into DONHANG VALUES('HD18050101', '16', N'Đoàn Thị Mỹ Kiều', '2018-05-01', 9870000, 'nv001')
insert into DONHANG VALUES('HD18060101', '17', N'Võ Đăng Quang', '2018-06-01', 6870000, 'nv001')
insert into DONHANG VALUES('HD18070101', '17', N'Võ Đăng Quang', '2018-07-01', 5490000, 'nv001')
insert into DONHANG VALUES('HD18080101', '18', N'Bùi Minh Thông', '2018-08-01', 8790000, 'nv001')
insert into DONHANG VALUES('HD18090101', '18', N'Bùi Minh Thông', '2018-09-01', 8690000, 'nv001')
insert into DONHANG VALUES('HD18100101', '19', N'Đoàn Hoàng Sang', '2018-10-01', 9840000, 'nv001')
insert into DONHANG VALUES('HD18110101', '20', N'Lữ Bố', '2018-11-01', 8790000, 'nv001')
insert into DONHANG VALUES('HD18120101', '21', N'Chung Vô Diệm', '2018-12-01', 8780000, 'nv001')

insert into DONHANG VALUES('HD17010101', '32', N'Võ Thị Cẩm Nguyệt', '2017-01-01', 8280000, 'nv001')
insert into DONHANG VALUES('HD17020101', '32', N'Trần Minh Hào', '2017-02-01', 5950000, 'nv001')
insert into DONHANG VALUES('HD17030101', '32', N'Đoàn Trương Gia Bảo', '2017-03-01', 7170000, 'nv001')
insert into DONHANG VALUES('HD17040101', '15', N'Đoàn Thị Mỹ Hẹn', '2017-04-01', 9090000, 'nv001')
insert into DONHANG VALUES('HD17050101', '16', N'Đoàn Thị Mỹ Kiều', '2017-05-01', 9370000, 'nv001')
insert into DONHANG VALUES('HD17060101', '17', N'Võ Đăng Quang', '2017-06-01', 6070000, 'nv001')
insert into DONHANG VALUES('HD17070101', '17', N'Võ Đăng Quang', '2017-07-01', 9490000, 'nv001')
insert into DONHANG VALUES('HD17080101', '18', N'Bùi Minh Thông', '2017-08-01', 6790000, 'nv001')
insert into DONHANG VALUES('HD17090101', '18', N'Bùi Minh Thông', '2017-09-01', 8670000, 'nv001')
insert into DONHANG VALUES('HD17100101', '19', N'Đoàn Hoàng Sang', '2017-10-01', 9540000, 'nv001')
insert into DONHANG VALUES('HD17110101', '20', N'Lữ Bố', '2017-11-01', 8290000, 'nv001')
insert into DONHANG VALUES('HD17120101', '21', N'Chung Vô Diệm', '2017-12-01', 8080000, 'nv001')

insert into DONHANG VALUES('HD20020201', '32', N'Võ Thị Cẩm Nguyệt', '2020-02-02', 8280000, 'nv001')
insert into DONHANG VALUES('HD20020301', '32', N'Trần Minh Hào', '2020-02-03', 5950000, 'nv001')
insert into DONHANG VALUES('HD20020401', '32', N'Đoàn Trương Gia Bảo', '2020-02-04', 7170000, 'nv001')
insert into DONHANG VALUES('HD20020501', '15', N'Đoàn Thị Mỹ Hẹn', '2020-02-05', 9090000, 'nv001')
insert into DONHANG VALUES('HD20020601', '16', N'Đoàn Thị Mỹ Kiều', '2020-02-06', 9370000, 'nv001')
insert into DONHANG VALUES('HD20020701', '17', N'Võ Đăng Quang', '2020-02-07', 6070000, 'nv001')
insert into DONHANG VALUES('HD20020801', '17', N'Võ Đăng Quang', '2020-02-08', 9490000, 'nv001')
insert into DONHANG VALUES('HD20020901', '18', N'Bùi Minh Thông', '2020-02-09', 6790000, 'nv001')
insert into DONHANG VALUES('HD20021001', '18', N'Bùi Minh Thông', '2020-02-10', 8670000, 'nv001')
insert into DONHANG VALUES('HD20021101', '19', N'Đoàn Hoàng Sang', '2020-02-11', 9540000, 'nv001')
insert into DONHANG VALUES('HD20021201', '20', N'Lữ Bố', '2020-02-12', 8290000, 'nv001')
insert into DONHANG VALUES('HD20021301', '21', N'Chung Vô Diệm', '2020-02-13', 8080000, 'nv001')
insert into DONHANG VALUES('HD20021401', '32', N'Võ Thị Cẩm Nguyệt', '2020-02-14', 8280000, 'nv001')
insert into DONHANG VALUES('HD20021501', '32', N'Trần Minh Hào', '2020-02-15', 5950000, 'nv001')
insert into DONHANG VALUES('HD20021601', '32', N'Đoàn Trương Gia Bảo', '2020-02-16', 7170000, 'nv001')
insert into DONHANG VALUES('HD20021701', '15', N'Đoàn Thị Mỹ Hẹn', '2020-02-17', 9090000, 'nv001')
insert into DONHANG VALUES('HD20021801', '16', N'Đoàn Thị Mỹ Kiều', '2020-02-18', 9370000, 'nv001')
insert into DONHANG VALUES('HD20021901', '17', N'Võ Đăng Quang', '2020-02-19', 6070000, 'nv001')
insert into DONHANG VALUES('HD20022001', '17', N'Võ Đăng Quang', '2020-02-20', 9490000, 'nv001')
insert into DONHANG VALUES('HD20022101', '18', N'Bùi Minh Thông', '2020-02-21', 6790000, 'nv001')
insert into DONHANG VALUES('HD20022201', '18', N'Bùi Minh Thông', '2020-02-22', 8670000, 'nv001')
insert into DONHANG VALUES('HD20022301', '19', N'Đoàn Hoàng Sang', '2020-02-23', 9540000, 'nv001')
insert into DONHANG VALUES('HD20022401', '20', N'Lữ Bố', '2020-02-24', 8290000, 'nv001')
insert into DONHANG VALUES('HD20022501', '21', N'Chung Vô Diệm', '2020-02-25', 8080000, 'nv001')
insert into DONHANG VALUES('HD20022601', '32', N'Võ Thị Cẩm Nguyệt', '2020-02-26', 8280000, 'nv001')
insert into DONHANG VALUES('HD20022701', '32', N'Trần Minh Hào', '2020-02-27', 5950000, 'nv001')
insert into DONHANG VALUES('HD20022801', '32', N'Đoàn Trương Gia Bảo', '2020-02-28', 7170000, 'nv001')
insert into DONHANG VALUES('HD20022901', '15', N'Đoàn Thị Mỹ Hẹn', '2020-02-29', 9090000, 'nv001')
